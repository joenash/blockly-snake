<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Blockly Snake</title>

        <script src="/scripts/blockly/blockly_compressed.js"></script>
        <script src="/scripts/blockly/blocks_compressed.js"></script>
        <script src="/scripts/blockly/msg/en.js"></script>
        <script src="/scripts/blockly/javascript_compressed.js"></script>
        <script src="/blocks/json.js"></script>
        <script src="/blocks/console_log.js"></script>
        <script src="/blocks/snake.js"></script>
        
        
    </head>
    <body style="margin:0;">
    <div id="blocklyDiv" style="height: 100vh; width:98vw;"></div>
    <pre id="textarea"></pre>
    {% include "partials/toolbox.html" %}
    <script src="/scripts/socket.io/client-dist/socket.io.js"></script>
    <script>
        var socket = io();

        socket.on("receiveMove", (gameState, callback) => {
            console.log("Move received");
            var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
            const move = eval(code);
            //console.log({gameState, callback, move})
            console.log(move);
            callback(move);
            //(new Function("generated", code))();
        });

        var demoWorkspace = Blockly.inject('blocklyDiv',
            {media: 'https://unpkg.com/blockly/media/',
             toolbox: document.getElementById('toolbox')});

        load();

        function myUpdateFunction(event) {
            var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
            var dom = Blockly.Xml.workspaceToDom(demoWorkspace);
            save(dom);
            document.getElementById('textarea').innerHTML = code;
        }
        demoWorkspace.addChangeListener(myUpdateFunction);

        function save(dom){
            let text = Blockly.Xml.domToText(dom)
            console.log(text);
            localStorage.setItem("state", text);
        }

        function load(){
            let loadedState = localStorage.getItem("state");
            if (loadedState !== null) {
                let xml = Blockly.Xml.textToDom(loadedState);
                Blockly.Xml.appendDomToWorkspace(xml, demoWorkspace);
            }
            
        }

             
    </script>
    </body>
    
</html>
